<% if @musical_piece.is_active == true %>
  <div class='container'>
    <div class="row">
      <h4 class="px-5 py-2 mt-5 ml-5 bg-light text-dark">
        <%= @musical_piece.composer.name_kana %> :<%= @musical_piece.musical_piece_name %>
      </h4>
    </div>
    <div class='row'>
      <div class='col-xs-6 col-lg-3'>
        <!------------>
        <!--楽曲情報-->
        <!------------>
        <table class='table table-bordered border-dark text-nowrap'>
          <tr><th class="table-secondary">作曲年</th><td><%= @musical_piece.year_of_composition %></td></tr>
          <tr><th class="table-secondary">総演奏時間[min]</th><td><%= @musical_piece.performance_time %></td></tr>
          <tr><th class="table-secondary">参考リンク</th><td>
            <%= link_to "別タブへ", @musical_piece.reference_URL, target: :_blank, rel: "noopener noreferrer" %>
          </td></tr>
        </table>
        <% if @musical_piece_comment.errors.any? %>
          <div class = "alert">
            <ul>
              <% @musical_piece_comment.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <% if  @musical_piece_comments.where(member_id: current_member.id).present? %>
         <p>すでにコメントを投稿済みです</p>

        <% else %>
          <!---------------->
          <!--コメント投稿-->
          <!---------------->
          <%= form_with model: @musical_piece_comment, url: musical_piece_musical_pieces_comments_path(musical_piece_id: @musical_piece.id), local:true, method: :post do |f| %>
            <div>
              <%= f.label :comment,'コメント' %>
              <%= f.text_area :comment, size: "30x10" %>
            </div>
             <!--評価-->
            <div class="form-group row text-nowrap" id="star">
              <%= f.label :evaluation,'評価', class: 'col-md-3 col-form-label' %>
              <%= f.hidden_field :evaluation, id: :evaluation_star %>
            </div>
             <!--評価javascript-->
            <script>
            $('#star').empty();//これを入れないとブラウザバックする度に空の星が5つ増えてしまう
            $('#star').raty({
              size     : 36,
              starOff:  '<%= asset_path('star-off.png') %>',
              starOn : '<%= asset_path('star-on.png') %>',
              starHalf: '<%= asset_path('star-half.png') %>',
              // # MusicalPieceCommentモデルのevaluationカラムに値を保存する
              scoreName: 'musical_piece_comment[evaluation]',
              // ★の半分の入力を行う
              half: true
            });
            </script>
            <div>
              <%= f.submit "コメント投稿", class: 'btn btn-success' %>
            </div>
          <% end %>
        <% end %>
      </div>
      <!---------------->
      <!--コメント一覧-->
      <!---------------->
      <div class='col-xs-6 col-lg-8 offset-1'>
        <table class='table table-striped'>
          <% @musical_piece.musical_piece_comments.each do |mc| %>
            <tr>
              <div class='text-nowrap'>
                <%= link_to member_path(mc.member) do %>
                  <%= attachment_image_tag(mc.member, :profile_image, fallback: "no_image.jpg", size: "50x50") %>
                  <%= mc.member.nickname %>
                <% end %>
              </div>
              <div class="musical_piece-evaluation text-nowrap" data-score="<%= mc.evaluation %>"></div>
              <div><%= l mc.created_at, formats: :long %>にレビュー済み</div>
              <div style="word-wrap:break-word;"><%= mc.comment %></div>
              <% if mc.member == current_member %>
                <div>
                  <%= link_to "削除", musical_piece_musical_pieces_comment_path(mc.musical_piece, mc), method: :delete, remote: true, data: {confirm: "削除しますか？"}, class: "btn-sm btn-outline-danger" %>
                </div>
              <% end %>
            </tr>
          <% end %>
        </table>
        <script>
          $('.musical_piece-evaluation').empty();//これを入れないとブラウザバックする度に空の星が5つ増えてしまう
          $('.musical_piece-evaluation').raty({
            readOnly: true,
            score: function() {
              return $(this).attr('data-score');
            },
            path: '/assets/'
          });
        </script>
      </div>
    </div>
  </div>
<% end %>